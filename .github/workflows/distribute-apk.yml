name: Distribute APK

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'Release notes for testers'
        required: false
        default: 'New build available for testing'
        type: string
      create_release:
        description: 'Create a GitHub release'
        required: false
        default: true
        type: boolean

jobs:
  distribute:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Debug APK
        run: ./gradlew assembleDebug

      - name: Get version info
        id: version
        run: |
          VERSION_NAME=$(grep -oP 'versionName\s*=\s*"\K[^"]+' app/build.gradle.kts || echo "1.0")
          VERSION_CODE=$(grep -oP 'versionCode\s*=\s*\K\d+' app/build.gradle.kts || echo "1")
          BUILD_NUMBER=${{ github.run_number }}
          echo "version_name=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "version_code=${VERSION_CODE}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "tag_name=v${VERSION_NAME}-build${BUILD_NUMBER}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        if: github.event.inputs.create_release != 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: Build ${{ steps.version.outputs.build_number }} (v${{ steps.version.outputs.version_name }})
          body: |
            ## MTB Analyzer Build ${{ steps.version.outputs.build_number }}

            **Version:** ${{ steps.version.outputs.version_name }}
            **Build:** ${{ steps.version.outputs.build_number }}
            **Commit:** ${{ github.sha }}

            ### Release Notes
            ${{ github.event.inputs.release_notes || 'Automated build from main branch' }}

            ### Installation
            1. Download the APK file below
            2. Enable "Install from unknown sources" on your Android device
            3. Open the downloaded APK to install

            Or scan the QR code in the workflow artifacts to download directly to your device.
          files: app/build/outputs/apk/debug/app-debug.apk
          prerelease: true
          generate_release_notes: true

      - name: Generate QR Code
        run: |
          # Install qrcode CLI
          npm install -g qrcode

          # Get the release download URL
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag_name }}/app-debug.apk"

          # Generate QR code PNG
          qrcode -o qr-code.png "$RELEASE_URL"

          # Also generate text version for logs
          echo "Download URL: $RELEASE_URL"
          npx qrcode-terminal "$RELEASE_URL" || true

      - name: Upload QR Code
        uses: actions/upload-artifact@v4
        with:
          name: install-qr-code
          path: qr-code.png
          retention-days: 30

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-build-${{ steps.version.outputs.build_number }}
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      - name: Summary
        run: |
          echo "## Build Distribution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number:** ${{ steps.version.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Tag:** ${{ steps.version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download" >> $GITHUB_STEP_SUMMARY
          echo "[Download APK](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag_name }}/app-debug.apk)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### QR Code" >> $GITHUB_STEP_SUMMARY
          echo "Download the \`install-qr-code\` artifact for a scannable QR code." >> $GITHUB_STEP_SUMMARY
